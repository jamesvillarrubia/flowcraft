================================================
FILE: readme.md
================================================
# Pinion

[![CI](https://github.com/feathershq/pinion/actions/workflows/nodejs.yml/badge.svg)](https://github.com/feathershq/pinion/actions/workflows/nodejs.yml)
[![Download Status](https://img.shields.io/npm/dm/@featherscloud/pinion.svg?style=flat-square)](https://www.npmjs.com/package/@featherscloud/pinion)

> A fast and typesafe code generator

Pinion is a task runner and scaffolding tool that lets you create code generators for any language. Using TypeScript, it gives you full flexibility over what you can do and provides typesafe templating out-of-the box.

## Quick start

Install Pinion into your project via:

```
npm install @featherscloud/pinion --save-dev
```

Then create your first generator file e.g. in `generators/readme.tpl.ts` like this:

```ts
import { PinionContext, toFile, renderTemplate } from '@featherscloud/pinion'

// A template for a markdown Readme file
const readme = () => `
# Hello world

This is a readme generated by Pinion

Copyright (c) ${new Date().getFullYear()}
`

export const generate = (init: PinionContext) =>
  Promise.resolve(init)
    // Render the readme template
    .then(renderTemplate(readme, toFile('readme.md')))
```

Then run

```
npx pinion generators/readme.tpl.ts
```

## Documentation

Head over to the [Pinion documentation](https://feathers.cloud/pinion) for the full documentation.

## License

Copyright (c) 2024 Feathers Cloud Inc.

Licensed under the [MIT license](./LICENSE).



================================================
FILE: changelog.md
================================================
# Change Log

All notable changes to this project will be documented in this file.
See [Conventional Commits](https://conventionalcommits.org) for commit guidelines.

## [0.5.5](https://github.com/feathershq/pinion/compare/v0.5.4...v0.5.5) (2024-10-17)

### Bug Fixes

- Support absolute file path for CLI ([#73](https://github.com/feathershq/pinion/issues/73)) ([da20207](https://github.com/feathershq/pinion/commit/da202072f05740aa9cdf1408aaa92162853dee65))
- Update all dependencies and fix task ([#72](https://github.com/feathershq/pinion/issues/72)) ([322b141](https://github.com/feathershq/pinion/commit/322b141b3d3ad59dfe227e0c92259767e5cb4a43))

## [0.5.4](https://github.com/feathershq/pinion/compare/v0.5.3...v0.5.4) (2024-04-10)

### Bug Fixes

- Set minimum Node engine to v20 and update dependencies ([#68](https://github.com/feathershq/pinion/issues/68)) ([a618928](https://github.com/feathershq/pinion/commit/a618928b9bac931062bd197b6e51356370cde5ae))

## [0.5.3](https://github.com/feathershq/pinion/compare/v0.5.2...v0.5.3) (2024-01-28)

### Bug Fixes

- **import:** Use file paths as URL ([#62](https://github.com/feathershq/pinion/issues/62)) ([d1a8e8a](https://github.com/feathershq/pinion/commit/d1a8e8ac173331dc1d98968931144a7ca722f16a))

## [0.5.2](https://github.com/feathershq/pinion/compare/v0.5.1...v0.5.2) (2024-01-27)

### Bug Fixes

- Ensure all module names are proper URLs ([#61](https://github.com/feathershq/pinion/issues/61)) ([4dbd176](https://github.com/feathershq/pinion/commit/4dbd176dbbdeb2c20bf46de8a9cf6c240fe4e25d))

## [0.5.1](https://github.com/feathershq/pinion/compare/v0.5.0...v0.5.1) (2024-01-25)

### Bug Fixes

- Ensure all module URLs start with file: ([#59](https://github.com/feathershq/pinion/issues/59)) ([53ce826](https://github.com/feathershq/pinion/commit/53ce826c945eecd589a0b8f3ed7182980ccc59f9))

# [0.5.0](https://github.com/feathershq/pinion/compare/v0.5.0-pre.4...v0.5.0) (2024-01-19)

### Bug Fixes

- Fix package.json lib field ([#58](https://github.com/feathershq/pinion/issues/58)) ([5622a5c](https://github.com/feathershq/pinion/commit/5622a5cebd248bb03922d07265199dfcd8feaf60))

# [0.5.0-pre.4](https://github.com/feathershq/pinion/compare/v0.5.0-pre.3...v0.5.0-pre.4) (2024-01-18)

### Bug Fixes

- **pinion:** Make arguments in exec task callable ([#57](https://github.com/feathershq/pinion/issues/57)) ([414a45c](https://github.com/feathershq/pinion/commit/414a45cc1f8832f912b38ad5d1a66ea3aea0a93c))

# [0.5.0-pre.3](https://github.com/feathershq/pinion/compare/v0.5.0-pre.2...v0.5.0-pre.3) (2024-01-06)

**Note:** Version bump only for package pinion

# [0.5.0-pre.2](https://github.com/feathershq/pinion/compare/v0.5.0-pre.1...v0.5.0-pre.2) (2024-01-06)

### Bug Fixes

- Fix module loading and readme example ([#55](https://github.com/feathershq/pinion/issues/55)) ([60b85b7](https://github.com/feathershq/pinion/commit/60b85b702f30327718b24758dcc4e1dc7f485557))

# [0.5.0-pre.1](https://github.com/feathershq/pinion/compare/v0.4.0-pre.3...v0.5.0-pre.1) (2024-01-06)

### Bug Fixes

- Improve generic type inference ([#42](https://github.com/feathershq/pinion/issues/42)) ([e1e860c](https://github.com/feathershq/pinion/commit/e1e860cb0a837ebe717f7b352abb947809d6ded1))

### Features

- Add commander task for CLI option parsing ([#48](https://github.com/feathershq/pinion/issues/48)) ([cf3fc7a](https://github.com/feathershq/pinion/commit/cf3fc7a2afb43abaa07999be308cde5903394688))
- Add exec task and remove install task ([#50](https://github.com/feathershq/pinion/issues/50)) ([8fa4d4e](https://github.com/feathershq/pinion/commit/8fa4d4e9feb641df560576c80ba1e8b672fef878))
- Allow plan upgrades ([#41](https://github.com/feathershq/pinion/issues/41)) ([be72794](https://github.com/feathershq/pinion/commit/be72794e9e8daae87bb9bb156e53c25e9090f2be))
- Infer prompt answers ([#28](https://github.com/feathershq/pinion/issues/28)) ([a20827a](https://github.com/feathershq/pinion/commit/a20827af38ccdc2b3eb64ac787333d15ca61fd5b))
- Move to ES modules and tsx ([#47](https://github.com/feathershq/pinion/issues/47)) ([499c916](https://github.com/feathershq/pinion/commit/499c9165a53ee1a137e4a32e3a1ab01bbbadb186))
- Remove GPT integration and rename operations to tasks ([#45](https://github.com/feathershq/pinion/issues/45)) ([f6a7605](https://github.com/feathershq/pinion/commit/f6a7605099260d61d75a20fb02fa300104d5807f))

# [0.5.0-pre.0](https://github.com/feathershq/pinion/compare/v0.4.0-pre.3...v0.5.0-pre.0) (2024-01-06)

### Bug Fixes

- Improve generic type inference ([#42](https://github.com/feathershq/pinion/issues/42)) ([e1e860c](https://github.com/feathershq/pinion/commit/e1e860cb0a837ebe717f7b352abb947809d6ded1))

### Features

- Add commander task for CLI option parsing ([#48](https://github.com/feathershq/pinion/issues/48)) ([cf3fc7a](https://github.com/feathershq/pinion/commit/cf3fc7a2afb43abaa07999be308cde5903394688))
- Add exec task and remove install task ([#50](https://github.com/feathershq/pinion/issues/50)) ([8fa4d4e](https://github.com/feathershq/pinion/commit/8fa4d4e9feb641df560576c80ba1e8b672fef878))
- Allow plan upgrades ([#41](https://github.com/feathershq/pinion/issues/41)) ([be72794](https://github.com/feathershq/pinion/commit/be72794e9e8daae87bb9bb156e53c25e9090f2be))
- Infer prompt answers ([#28](https://github.com/feathershq/pinion/issues/28)) ([a20827a](https://github.com/feathershq/pinion/commit/a20827af38ccdc2b3eb64ac787333d15ca61fd5b))
- Move to ES modules and tsx ([#47](https://github.com/feathershq/pinion/issues/47)) ([499c916](https://github.com/feathershq/pinion/commit/499c9165a53ee1a137e4a32e3a1ab01bbbadb186))
- Remove GPT integration and rename operations to tasks ([#45](https://github.com/feathershq/pinion/issues/45)) ([f6a7605](https://github.com/feathershq/pinion/commit/f6a7605099260d61d75a20fb02fa300104d5807f))

# [0.4.0-pre.3](https://github.com/feathershq/pinion/compare/v0.4.0-pre.2...v0.4.0-pre.3) (2023-06-16)

### Bug Fixes

- Properly export GPT operation and utilities ([#40](https://github.com/feathershq/pinion/issues/40)) ([f88a705](https://github.com/feathershq/pinion/commit/f88a705814810aaf3f50b492859344338b8a36ba))

# [0.4.0-pre.2](https://github.com/feathershq/pinion/compare/v0.4.0-pre.1...v0.4.0-pre.2) (2023-06-16)

### Bug Fixes

- Improve CLI commands ([#39](https://github.com/feathershq/pinion/issues/39)) ([f768c1d](https://github.com/feathershq/pinion/commit/f768c1d4e705977a860589996f08acf51d61512d))

# [0.4.0-pre.1](https://github.com/feathershq/pinion/compare/v0.4.0-pre.0...v0.4.0-pre.1) (2023-06-16)

### Bug Fixes

- Update feathers.cloud API client ([#38](https://github.com/feathershq/pinion/issues/38)) ([a3cb51e](https://github.com/feathershq/pinion/commit/a3cb51e9c699633b5553c1aa2cffea0f2be06fe3))

# [0.4.0-pre.0](https://github.com/feathershq/pinion/compare/v0.3.5...v0.4.0-pre.0) (2023-06-16)

### Bug Fixes

- Update dependencies and remove chalk ([#31](https://github.com/feathershq/pinion/issues/31)) ([5939b6f](https://github.com/feathershq/pinion/commit/5939b6fdbaab563be1dd56de2873f5bdf7db9094))

### Features

- Move to Commander for command line arguments ([#33](https://github.com/feathershq/pinion/issues/33)) ([2b51267](https://github.com/feathershq/pinion/commit/2b512670be9ef45c0b1fc647e403bc03252fd04b))
- Pinion GPT ([#37](https://github.com/feathershq/pinion/issues/37)) ([756e81a](https://github.com/feathershq/pinion/commit/756e81a31971e0b91e913f9719fa91082f7f1164))

## [0.3.5](https://github.com/feathershq/pinion/compare/v0.3.4...v0.3.5) (2022-08-03)

**Note:** Version bump only for package pinion

## [0.3.4](https://github.com/feathershq/pinion/compare/v0.3.3...v0.3.4) (2022-07-28)

### Bug Fixes

- Fix spawn command to work properly with Windows ([#23](https://github.com/feathershq/pinion/issues/23)) ([9064c55](https://github.com/feathershq/pinion/commit/9064c558845d22f576e7b4b615fd9ea26b41b8d0))

## [0.3.3](https://github.com/feathershq/pinion/compare/v0.3.2...v0.3.3) (2022-06-21)

### Bug Fixes

- Fix conditional evaluation issue ([#22](https://github.com/feathershq/pinion/issues/22)) ([6a62acc](https://github.com/feathershq/pinion/commit/6a62acc98f42a6df2f6050304ddfdbbc14d95e15))

## [0.3.2](https://github.com/feathershq/pinion/compare/v0.3.1...v0.3.2) (2022-06-21)

### Bug Fixes

- Improve notice logging and make conditional more flexible ([#21](https://github.com/feathershq/pinion/issues/21)) ([7550650](https://github.com/feathershq/pinion/commit/75506505cfd4014b8f2e1bcbc18303b995c4356e))

## [0.3.1](https://github.com/feathershq/pinion/compare/v0.3.0...v0.3.1) (2022-05-20)

### Bug Fixes

- Allow prompt to specify a different return type ([#17](https://github.com/feathershq/pinion/issues/17)) ([5d893da](https://github.com/feathershq/pinion/commit/5d893da11d72c8a3454029384c8a17ca2c10237d))
- Fix inject after handling and add error messages when lines were not found ([#19](https://github.com/feathershq/pinion/issues/19)) ([ceb9696](https://github.com/feathershq/pinion/commit/ceb9696c4330d5b132407a3930f32bad6b9dcd26))

### Features

- Add tracing mechanism ([#18](https://github.com/feathershq/pinion/issues/18)) ([4e20211](https://github.com/feathershq/pinion/commit/4e202117218b56e564321f2fa40fb80d19dfd597))

# [0.3.0](https://github.com/feathershq/pinion/compare/v0.2.7...v0.3.0) (2022-05-19)

### Features

- Do not merge context and remove runGenerator ([#16](https://github.com/feathershq/pinion/issues/16)) ([60c7e9e](https://github.com/feathershq/pinion/commit/60c7e9efacc51ecd4290bf9404fe40ee3f9660f3))

## [0.2.7](https://github.com/feathershq/pinion/compare/v0.2.6...v0.2.7) (2022-05-06)

### Bug Fixes

- Only run generators in the current folder, not recursively ([#15](https://github.com/feathershq/pinion/issues/15)) ([6e74853](https://github.com/feathershq/pinion/commit/6e7485345e9d95d942081d0b739c1b9afc008f9a))

## [0.2.6](https://github.com/feathershq/pinion/compare/v0.2.5...v0.2.6) (2022-05-03)

### Bug Fixes

- Escape inject pattern strings to not be treated as regular expressions ([#14](https://github.com/feathershq/pinion/issues/14)) ([ebfbdd7](https://github.com/feathershq/pinion/commit/ebfbdd75243dc3fa1bcc935d0420f5d935d14b6a))

## [0.2.5](https://github.com/feathershq/pinion/compare/v0.2.4...v0.2.5) (2022-05-02)

### Bug Fixes

- Fix runGenerator return type ([#12](https://github.com/feathershq/pinion/issues/12)) ([3f7bd1a](https://github.com/feathershq/pinion/commit/3f7bd1a1552f6762d6892dd054bd163f2c2cb5ed))

### Features

- Add when helper for conditional operations ([#13](https://github.com/feathershq/pinion/issues/13)) ([f75409d](https://github.com/feathershq/pinion/commit/f75409de4f5c0d8c754eda85732182ff0fa3a67f))

## [0.2.4](https://github.com/feathershq/pinion/compare/v0.2.3...v0.2.4) (2022-04-16)

### Bug Fixes

- Improve generator execution flow ([f47ec38](https://github.com/feathershq/pinion/commit/f47ec38aab281c1db46fe31738dd8a9697dd3191))

### Features

- Add copyFiles and mergeJSON operations ([#11](https://github.com/feathershq/pinion/issues/11)) ([4f8c2e2](https://github.com/feathershq/pinion/commit/4f8c2e27515c20b7cd64934dc91a7165e4075f1b))

## [0.2.3](https://github.com/feathershq/pinion/compare/v0.2.2...v0.2.3) (2022-03-25)

**Note:** Version bump only for package pinion

## [0.2.2](https://github.com/feathershq/pinion/compare/v0.2.1...v0.2.2) (2022-03-11)

### Features

- Add simple package manager installation script ([#9](https://github.com/feathershq/pinion/issues/9)) ([5bbb767](https://github.com/feathershq/pinion/commit/5bbb76768f4a5f8f97bc2e088ed061f44ca2a75d))

## [0.2.1](https://github.com/feathershq/pinion/compare/v0.2.0...v0.2.1) (2022-03-10)

### Features

- Add loadJSON and writeJSON operations ([#7](https://github.com/feathershq/pinion/issues/7)) ([157c2ed](https://github.com/feathershq/pinion/commit/157c2ede34e511631855d4a81600e5f33eec4ff7))
- Allow to load compiled modules first and improve operations ([#8](https://github.com/feathershq/pinion/issues/8)) ([b7a347f](https://github.com/feathershq/pinion/commit/b7a347fac32fe7d678a2ddb59aedaf03e95f3d9e))

# [0.2.0](https://github.com/feathershq/pinion/compare/v0.1.0...v0.2.0) (2022-03-07)

### Bug Fixes

- Update package-lock.json for republish ([f8bad4e](https://github.com/feathershq/pinion/commit/f8bad4efe9dfc1e431cbc22aef9b10e27f1285ca))
- Update references and trigger re-publish ([fb9060c](https://github.com/feathershq/pinion/commit/fb9060c359a7a3bd9ffd62c85fc6474f85dde6d3))

### Features

- Add inject operation ([#6](https://github.com/feathershq/pinion/issues/6)) ([b22af84](https://github.com/feathershq/pinion/commit/b22af84245bce5c57b8252ff77d36e618275e986))
- Improve CLI and add converter functionality ([#5](https://github.com/feathershq/pinion/issues/5)) ([6733c98](https://github.com/feathershq/pinion/commit/6733c987aff4f5d24183cf0473fe2ba6fc123f6d))

## [0.1.1](https://github.com/feathershq/pinion/compare/v0.1.0...v0.1.1) (2022-03-02)

### Bug Fixes

- Update package-lock.json for republish ([f8bad4e](https://github.com/feathershq/pinion/commit/f8bad4efe9dfc1e431cbc22aef9b10e27f1285ca))
- Update references and trigger re-publish ([fb9060c](https://github.com/feathershq/pinion/commit/fb9060c359a7a3bd9ffd62c85fc6474f85dde6d3))

# 0.1.0 (2022-03-01)

### Features

- Initial Pinion prototype ([#3](https://github.com/feathershq/pinion/issues/3)) ([b08aacf](https://github.com/feathershq/pinion/commit/b08aacf22a5a61587243683a7d83097dbb576801))



================================================
FILE: lerna.json
================================================
{
  "packages": ["packages/*"],
  "version": "0.5.5",
  "command": {
    "bootstrap": {
      "hoist": true
    },
    "publish": {
      "allowBranch": ["main"],
      "message": "chore(release): publish %s",
      "conventionalCommits": true,
      "createRelease": "github"
    }
  },
  "ignoreChanges": [
    "**/changelog.md",
    "**/CHANGELOG.md",
    "**/package-lock.json",
    "**/yarn.lock",
    "**/test/**",
    "lerna.json",
    "readme.md"
  ]
}



================================================
FILE: LICENSE
================================================
The MIT License (MIT)

Copyright (c) 2022 Feathers Cloud Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.



================================================
FILE: package.json
================================================
{
  "name": "pinion",
  "private": true,
  "homepage": "http://feathersjs.com",
  "repository": {
    "type": "git",
    "url": "git://github.com/feathershq/pinion.git"
  },
  "author": {
    "name": "Feathers Cloud Inc.",
    "email": "hello@feathers.cloud",
    "url": "https://feathers.cloud"
  },
  "type": "module",
  "license": "MIT",
  "funding": {
    "type": "github",
    "url": "https://github.com/sponsors/daffl"
  },
  "bugs": {
    "url": "https://github.com/feathershq/pinion/issues"
  },
  "engines": {
    "node": ">= 18"
  },
  "workspaces": [
    "packages/*"
  ],
  "scripts": {
    "publish": "lerna publish && npm run update-changelog",
    "publish:prerelease": "lerna publish prerelease --preid pre --pre-dist-tag pre --dist-tag pre && npm run update-changelog",
    "update-changelog": "git commit -am \"chore: Update changelog\" && git push origin",
    "prettier": "npx prettier \"packages/{,!(node_modules)/**/(src|test)/**/}*.ts\" --write",
    "eslint": "eslint \"packages/**/*.ts\" --fix",
    "lint": "npm run prettier && npm run eslint",
    "update-dependencies": "ncu -u -x eslint && lerna exec -- ncu -u",
    "dev": "vitest watch --coverage",
    "vitest": "vitest run --coverage",
    "test": "npm run lint && npm run compile --workspaces && npm run vitest"
  },
  "devDependencies": {
    "@typescript-eslint/eslint-plugin": "^8.19.0",
    "@typescript-eslint/parser": "^8.19.0",
    "@vitest/coverage-v8": "^2.1.8",
    "eslint": "^8.57.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-import": "^2.31.0",
    "eslint-plugin-node": "^11.1.0",
    "eslint-plugin-promise": "^7.2.1",
    "lerna": "^8.1.9",
    "npm-check-updates": "^17.1.13",
    "prettier": "^3.4.2",
    "typescript": "^5.7.2",
    "vitest": "^2.1.8"
  }
}


================================================
FILE: tsconfig.json
================================================
{
  "compilerOptions": {
    /* Visit https://aka.ms/tsconfig.json to read more about this file */

    /* Projects */
    // "incremental": true,                              /* Enable incremental compilation */
    // "composite": true,                                /* Enable constraints that allow a TypeScript project to be used with project references. */
    // "tsBuildInfoFile": "./",                          /* Specify the folder for .tsbuildinfo incremental compilation files. */
    // "disableSourceOfProjectReferenceRedirect": true,  /* Disable preferring source files instead of declaration files when referencing composite projects */
    // "disableSolutionSearching": true,                 /* Opt a project out of multi-project reference checking when editing. */
    // "disableReferencedProjectLoad": true,             /* Reduce the number of projects loaded automatically by TypeScript. */

    /* Language and Environment */
    "target": "es2018",                                  /* Set the JavaScript language version for emitted JavaScript and include compatible library declarations. */
    // "lib": [],                                        /* Specify a set of bundled library declaration files that describe the target runtime environment. */
    // "jsx": "preserve",                                /* Specify what JSX code is generated. */
    // "experimentalDecorators": true,                   /* Enable experimental support for TC39 stage 2 draft decorators. */
    // "emitDecoratorMetadata": true,                    /* Emit design-type metadata for decorated declarations in source files. */
    // "jsxFactory": "",                                 /* Specify the JSX factory function used when targeting React JSX emit, e.g. 'React.createElement' or 'h' */
    // "jsxFragmentFactory": "",                         /* Specify the JSX Fragment reference used for fragments when targeting React JSX emit e.g. 'React.Fragment' or 'Fragment'. */
    // "jsxImportSource": "",                            /* Specify module specifier used to import the JSX factory functions when using `jsx: react-jsx*`.` */
    // "reactNamespace": "",                             /* Specify the object invoked for `createElement`. This only applies when targeting `react` JSX emit. */
    // "noLib": true,                                    /* Disable including any library files, including the default lib.d.ts. */
    // "useDefineForClassFields": true,                  /* Emit ECMAScript-standard-compliant class fields. */

    /* Modules */
    "module": "NodeNext",                                /* Specify what module code is generated. */
    // "rootDir": "./",                                  /* Specify the root folder within your source files. */
    "moduleResolution": "NodeNext",                       /* Specify how TypeScript looks up a file from a given module specifier. */
    // "baseUrl": "./",                                  /* Specify the base directory to resolve non-relative module names. */
    // "paths": {},                                      /* Specify a set of entries that re-map imports to additional lookup locations. */
    // "rootDirs": [],                                   /* Allow multiple folders to be treated as one when resolving modules. */
    // "typeRoots": [],                                  /* Specify multiple folders that act like `./node_modules/@types`. */
    // "types": [],                                      /* Specify type package names to be included without being referenced in a source file. */
    // "allowUmdGlobalAccess": true,                     /* Allow accessing UMD globals from modules. */
    // "resolveJsonModule": true,                        /* Enable importing .json files */
    // "noResolve": true,                                /* Disallow `import`s, `require`s or `<reference>`s from expanding the number of files TypeScript should add to a project. */

    /* JavaScript Support */
    // "allowJs": true,                                  /* Allow JavaScript files to be a part of your program. Use the `checkJS` option to get errors from these files. */
    // "checkJs": true,                                  /* Enable error reporting in type-checked JavaScript files. */
    // "maxNodeModuleJsDepth": 1,                        /* Specify the maximum folder depth used for checking JavaScript files from `node_modules`. Only applicable with `allowJs`. */

    /* Emit */
    "declaration": true,                              /* Generate .d.ts files from TypeScript and JavaScript files in your project. */
    // "declarationMap": true,                           /* Create sourcemaps for d.ts files. */
    // "emitDeclarationOnly": true,                      /* Only output d.ts files and not JavaScript files. */
    "sourceMap": true,                                /* Create source map files for emitted JavaScript files. */
    // "outFile": "./",                                  /* Specify a file that bundles all outputs into one JavaScript file. If `declaration` is true, also designates a file that bundles all .d.ts output. */
    // "outDir": "./",                                   /* Specify an output folder for all emitted files. */
    // "removeComments": true,                           /* Disable emitting comments. */
    // "noEmit": true,                                   /* Disable emitting files from a compilation. */
    // "importHelpers": true,                            /* Allow importing helper functions from tslib once per project, instead of including them per-file. */
    // "importsNotUsedAsValues": "remove",               /* Specify emit/checking behavior for imports that are only used for types */
    // "downlevelIteration": true,                       /* Emit more compliant, but verbose and less performant JavaScript for iteration. */
    // "sourceRoot": "",                                 /* Specify the root path for debuggers to find the reference source code. */
    // "mapRoot": "",                                    /* Specify the location where debugger should locate map files instead of generated locations. */
    // "inlineSourceMap": true,                          /* Include sourcemap files inside the emitted JavaScript. */
    // "inlineSources": true,                            /* Include source code in the sourcemaps inside the emitted JavaScript. */
    // "emitBOM": true,                                  /* Emit a UTF-8 Byte Order Mark (BOM) in the beginning of output files. */
    // "newLine": "crlf",                                /* Set the newline character for emitting files. */
    // "stripInternal": true,                            /* Disable emitting declarations that have `@internal` in their JSDoc comments. */
    // "noEmitHelpers": true,                            /* Disable generating custom helper functions like `__extends` in compiled output. */
    // "noEmitOnError": true,                            /* Disable emitting files if any type checking errors are reported. */
    // "preserveConstEnums": true,                       /* Disable erasing `const enum` declarations in generated code. */
    // "declarationDir": "./",                           /* Specify the output directory for generated declaration files. */
    // "preserveValueImports": true,                     /* Preserve unused imported values in the JavaScript output that would otherwise be removed. */

    /* Interop Constraints */
    // "isolatedModules": true,                          /* Ensure that each file can be safely transpiled without relying on other imports. */
    // "allowSyntheticDefaultImports": true,             /* Allow 'import x from y' when a module doesn't have a default export. */
    "esModuleInterop": true,                             /* Emit additional JavaScript to ease support for importing CommonJS modules. This enables `allowSyntheticDefaultImports` for type compatibility. */
    // "preserveSymlinks": true,                         /* Disable resolving symlinks to their realpath. This correlates to the same flag in node. */
    "forceConsistentCasingInFileNames": true,            /* Ensure that casing is correct in imports. */

    /* Type Checking */
    "strict": true,                                      /* Enable all strict type-checking options. */
    // "noImplicitAny": true,                            /* Enable error reporting for expressions and declarations with an implied `any` type.. */
    // "strictNullChecks": true,                         /* When type checking, take into account `null` and `undefined`. */
    // "strictFunctionTypes": true,                      /* When assigning functions, check to ensure parameters and the return values are subtype-compatible. */
    // "strictBindCallApply": true,                      /* Check that the arguments for `bind`, `call`, and `apply` methods match the original function. */
    // "strictPropertyInitialization": true,             /* Check for class properties that are declared but not set in the constructor. */
    // "noImplicitThis": true,                           /* Enable error reporting when `this` is given the type `any`. */
    // "useUnknownInCatchVariables": true,               /* Type catch clause variables as 'unknown' instead of 'any'. */
    // "alwaysStrict": true,                             /* Ensure 'use strict' is always emitted. */
    // "noUnusedLocals": true,                           /* Enable error reporting when a local variables aren't read. */
    // "noUnusedParameters": true,                       /* Raise an error when a function parameter isn't read */
    // "exactOptionalPropertyTypes": true,               /* Interpret optional property types as written, rather than adding 'undefined'. */
    // "noImplicitReturns": true,                        /* Enable error reporting for codepaths that do not explicitly return in a function. */
    // "noFallthroughCasesInSwitch": true,               /* Enable error reporting for fallthrough cases in switch statements. */
    // "noUncheckedIndexedAccess": true,                 /* Include 'undefined' in index signature results */
    // "noImplicitOverride": true,                       /* Ensure overriding members in derived classes are marked with an override modifier. */
    // "noPropertyAccessFromIndexSignature": true,       /* Enforces using indexed accessors for keys declared using an indexed type */
    // "allowUnusedLabels": true,                        /* Disable error reporting for unused labels. */
    // "allowUnreachableCode": true,                     /* Disable error reporting for unreachable code. */

    /* Completeness */
    // "skipDefaultLibCheck": true,                      /* Skip type checking .d.ts files that are included with TypeScript. */
    "skipLibCheck": true                                 /* Skip type checking all .d.ts files. */
  }
}



================================================
FILE: vitest.config.ts
================================================
// vitest.config.ts
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    coverage: {
      provider: 'v8',
      include: ['packages/*/src/**/*.ts']
    }
  }
})



================================================
FILE: vitest.workspace.ts
================================================
import { defineWorkspace } from 'vitest/config'

// defineWorkspace provides a nice type hinting DX
export default defineWorkspace(['packages/*'])



================================================
FILE: .eslintrc.cjs
================================================
module.exports = {
  env: {
    es2021: true,
    node: true
  },
  extends: [
    'prettier'
  ],
  parser: '@typescript-eslint/parser',
  parserOptions: {
    ecmaVersion: 'latest',
    sourceType: 'module'
  },
  plugins: [
    '@typescript-eslint'
  ],
  ignorePatterns: ['**/lib/', '**/dist/'],
  rules: {
  }
}



================================================
FILE: .prettierrc
================================================
{
  "tabWidth": 2,
  "useTabs": false,
  "printWidth": 110,
  "semi": false,
  "trailingComma": "none",
  "singleQuote": true
}


================================================
FILE: packages/pinion/readme.md
================================================
# @featherscloud/pinion

[![CI](https://github.com/feathershq/pinion/actions/workflows/nodejs.yml/badge.svg)](https://github.com/feathershq/pinion/actions/workflows/nodejs.yml)
[![Download Status](https://img.shields.io/npm/dm/@featherscloud/pinion.svg?style=flat-square)](https://www.npmjs.com/package/@featherscloud/pinion)

> A fast and typesafe code generator

Pinion is a task runner and scaffolding tool that lets you create code generators for any language. Using TypeScript, it gives you full flexibility over what you can do and provides typesafe templating out-of-the box.

## Quick start

Install Pinion into your project via:

```
npm install @featherscloud/pinion --save-dev
```

Then create your first generator file e.g. in `generators/readme.tpl.ts` like this:

```ts
import { PinionContext, toFile, renderTemplate } from '@featherscloud/pinion'

// A template for a markdown Readme file
const readme = () => `
# Hello world

This is a readme generated by Pinion

Copyright (c) ${new Date().getFullYear()}
`

export const generate = (init: PinionContext) =>
  Promise.resolve(init)
    // Render the readme template
    .then(renderTemplate(readme, toFile('readme.md')))
```

Then run

```
npx pinion generators/readme.tpl.ts
```

## Documentation

Head over to the [Pinion documentation](https://feathers.cloud/pinion) for the full documentation.

## License

Copyright (c) 2024 Feathers Cloud Inc.

Licensed under the [MIT license](./LICENSE).



================================================
FILE: packages/pinion/changelog.md
================================================
# Change Log

All notable changes to this project will be documented in this file.
See [Conventional Commits](https://conventionalcommits.org) for commit guidelines.

## [0.5.5](https://github.com/feathershq/pinion/compare/v0.5.4...v0.5.5) (2024-10-17)

### Bug Fixes

- Support absolute file path for CLI ([#73](https://github.com/feathershq/pinion/issues/73)) ([da20207](https://github.com/feathershq/pinion/commit/da202072f05740aa9cdf1408aaa92162853dee65))
- Update all dependencies and fix task ([#72](https://github.com/feathershq/pinion/issues/72)) ([322b141](https://github.com/feathershq/pinion/commit/322b141b3d3ad59dfe227e0c92259767e5cb4a43))

## [0.5.4](https://github.com/feathershq/pinion/compare/v0.5.3...v0.5.4) (2024-04-10)

### Bug Fixes

- Set minimum Node engine to v20 and update dependencies ([#68](https://github.com/feathershq/pinion/issues/68)) ([a618928](https://github.com/feathershq/pinion/commit/a618928b9bac931062bd197b6e51356370cde5ae))

## [0.5.3](https://github.com/feathershq/pinion/compare/v0.5.2...v0.5.3) (2024-01-28)

### Bug Fixes

- **import:** Use file paths as URL ([#62](https://github.com/feathershq/pinion/issues/62)) ([d1a8e8a](https://github.com/feathershq/pinion/commit/d1a8e8ac173331dc1d98968931144a7ca722f16a))

## [0.5.2](https://github.com/feathershq/pinion/compare/v0.5.1...v0.5.2) (2024-01-27)

### Bug Fixes

- Ensure all module names are proper URLs ([#61](https://github.com/feathershq/pinion/issues/61)) ([4dbd176](https://github.com/feathershq/pinion/commit/4dbd176dbbdeb2c20bf46de8a9cf6c240fe4e25d))

## [0.5.1](https://github.com/feathershq/pinion/compare/v0.5.0...v0.5.1) (2024-01-25)

### Bug Fixes

- Ensure all module URLs start with file: ([#59](https://github.com/feathershq/pinion/issues/59)) ([53ce826](https://github.com/feathershq/pinion/commit/53ce826c945eecd589a0b8f3ed7182980ccc59f9))

# [0.5.0](https://github.com/feathershq/pinion/compare/v0.5.0-pre.4...v0.5.0) (2024-01-19)

### Bug Fixes

- Fix package.json lib field ([#58](https://github.com/feathershq/pinion/issues/58)) ([5622a5c](https://github.com/feathershq/pinion/commit/5622a5cebd248bb03922d07265199dfcd8feaf60))

# [0.5.0-pre.4](https://github.com/feathershq/pinion/compare/v0.5.0-pre.3...v0.5.0-pre.4) (2024-01-18)

### Bug Fixes

- **pinion:** Make arguments in exec task callable ([#57](https://github.com/feathershq/pinion/issues/57)) ([414a45c](https://github.com/feathershq/pinion/commit/414a45cc1f8832f912b38ad5d1a66ea3aea0a93c))

# [0.5.0-pre.3](https://github.com/feathershq/pinion/compare/v0.5.0-pre.2...v0.5.0-pre.3) (2024-01-06)

**Note:** Version bump only for package @featherscloud/pinion

# [0.5.0-pre.2](https://github.com/feathershq/pinion/compare/v0.5.0-pre.1...v0.5.0-pre.2) (2024-01-06)

### Bug Fixes

- Fix module loading and readme example ([#55](https://github.com/feathershq/pinion/issues/55)) ([60b85b7](https://github.com/feathershq/pinion/commit/60b85b702f30327718b24758dcc4e1dc7f485557))

# [0.5.0-pre.1](https://github.com/feathershq/pinion/compare/v0.4.0-pre.3...v0.5.0-pre.1) (2024-01-06)

### Bug Fixes

- Improve generic type inference ([#42](https://github.com/feathershq/pinion/issues/42)) ([e1e860c](https://github.com/feathershq/pinion/commit/e1e860cb0a837ebe717f7b352abb947809d6ded1))

### Features

- Add commander task for CLI option parsing ([#48](https://github.com/feathershq/pinion/issues/48)) ([cf3fc7a](https://github.com/feathershq/pinion/commit/cf3fc7a2afb43abaa07999be308cde5903394688))
- Add exec task and remove install task ([#50](https://github.com/feathershq/pinion/issues/50)) ([8fa4d4e](https://github.com/feathershq/pinion/commit/8fa4d4e9feb641df560576c80ba1e8b672fef878))
- Allow plan upgrades ([#41](https://github.com/feathershq/pinion/issues/41)) ([be72794](https://github.com/feathershq/pinion/commit/be72794e9e8daae87bb9bb156e53c25e9090f2be))
- Infer prompt answers ([#28](https://github.com/feathershq/pinion/issues/28)) ([a20827a](https://github.com/feathershq/pinion/commit/a20827af38ccdc2b3eb64ac787333d15ca61fd5b))
- Move to ES modules and tsx ([#47](https://github.com/feathershq/pinion/issues/47)) ([499c916](https://github.com/feathershq/pinion/commit/499c9165a53ee1a137e4a32e3a1ab01bbbadb186))
- Remove GPT integration and rename operations to tasks ([#45](https://github.com/feathershq/pinion/issues/45)) ([f6a7605](https://github.com/feathershq/pinion/commit/f6a7605099260d61d75a20fb02fa300104d5807f))

# [0.5.0-pre.0](https://github.com/feathershq/pinion/compare/v0.4.0-pre.3...v0.5.0-pre.0) (2024-01-06)

### Bug Fixes

- Improve generic type inference ([#42](https://github.com/feathershq/pinion/issues/42)) ([e1e860c](https://github.com/feathershq/pinion/commit/e1e860cb0a837ebe717f7b352abb947809d6ded1))

### Features

- Add commander task for CLI option parsing ([#48](https://github.com/feathershq/pinion/issues/48)) ([cf3fc7a](https://github.com/feathershq/pinion/commit/cf3fc7a2afb43abaa07999be308cde5903394688))
- Add exec task and remove install task ([#50](https://github.com/feathershq/pinion/issues/50)) ([8fa4d4e](https://github.com/feathershq/pinion/commit/8fa4d4e9feb641df560576c80ba1e8b672fef878))
- Allow plan upgrades ([#41](https://github.com/feathershq/pinion/issues/41)) ([be72794](https://github.com/feathershq/pinion/commit/be72794e9e8daae87bb9bb156e53c25e9090f2be))
- Infer prompt answers ([#28](https://github.com/feathershq/pinion/issues/28)) ([a20827a](https://github.com/feathershq/pinion/commit/a20827af38ccdc2b3eb64ac787333d15ca61fd5b))
- Move to ES modules and tsx ([#47](https://github.com/feathershq/pinion/issues/47)) ([499c916](https://github.com/feathershq/pinion/commit/499c9165a53ee1a137e4a32e3a1ab01bbbadb186))
- Remove GPT integration and rename operations to tasks ([#45](https://github.com/feathershq/pinion/issues/45)) ([f6a7605](https://github.com/feathershq/pinion/commit/f6a7605099260d61d75a20fb02fa300104d5807f))

# [0.4.0-pre.3](https://github.com/feathershq/pinion/compare/v0.4.0-pre.2...v0.4.0-pre.3) (2023-06-16)

### Bug Fixes

- Properly export GPT operation and utilities ([#40](https://github.com/feathershq/pinion/issues/40)) ([f88a705](https://github.com/feathershq/pinion/commit/f88a705814810aaf3f50b492859344338b8a36ba))

# [0.4.0-pre.2](https://github.com/feathershq/pinion/compare/v0.4.0-pre.1...v0.4.0-pre.2) (2023-06-16)

### Bug Fixes

- Improve CLI commands ([#39](https://github.com/feathershq/pinion/issues/39)) ([f768c1d](https://github.com/feathershq/pinion/commit/f768c1d4e705977a860589996f08acf51d61512d))

# [0.4.0-pre.1](https://github.com/feathershq/pinion/compare/v0.4.0-pre.0...v0.4.0-pre.1) (2023-06-16)

### Bug Fixes

- Update feathers.cloud API client ([#38](https://github.com/feathershq/pinion/issues/38)) ([a3cb51e](https://github.com/feathershq/pinion/commit/a3cb51e9c699633b5553c1aa2cffea0f2be06fe3))

# [0.4.0-pre.0](https://github.com/feathershq/pinion/compare/v0.3.5...v0.4.0-pre.0) (2023-06-16)

### Bug Fixes

- Update dependencies and remove chalk ([#31](https://github.com/feathershq/pinion/issues/31)) ([5939b6f](https://github.com/feathershq/pinion/commit/5939b6fdbaab563be1dd56de2873f5bdf7db9094))

### Features

- Move to Commander for command line arguments ([#33](https://github.com/feathershq/pinion/issues/33)) ([2b51267](https://github.com/feathershq/pinion/commit/2b512670be9ef45c0b1fc647e403bc03252fd04b))
- Pinion GPT ([#37](https://github.com/feathershq/pinion/issues/37)) ([756e81a](https://github.com/feathershq/pinion/commit/756e81a31971e0b91e913f9719fa91082f7f1164))

## [0.3.5](https://github.com/feathershq/pinion/compare/v0.3.4...v0.3.5) (2022-08-03)

**Note:** Version bump only for package @featherscloud/pinion

## [0.3.4](https://github.com/feathershq/pinion/compare/v0.3.3...v0.3.4) (2022-07-28)

### Bug Fixes

- Fix spawn command to work properly with Windows ([#23](https://github.com/feathershq/pinion/issues/23)) ([9064c55](https://github.com/feathershq/pinion/commit/9064c558845d22f576e7b4b615fd9ea26b41b8d0))

## [0.3.3](https://github.com/feathershq/pinion/compare/v0.3.2...v0.3.3) (2022-06-21)

### Bug Fixes

- Fix conditional evaluation issue ([#22](https://github.com/feathershq/pinion/issues/22)) ([6a62acc](https://github.com/feathershq/pinion/commit/6a62acc98f42a6df2f6050304ddfdbbc14d95e15))

## [0.3.2](https://github.com/feathershq/pinion/compare/v0.3.1...v0.3.2) (2022-06-21)

### Bug Fixes

- Improve notice logging and make conditional more flexible ([#21](https://github.com/feathershq/pinion/issues/21)) ([7550650](https://github.com/feathershq/pinion/commit/75506505cfd4014b8f2e1bcbc18303b995c4356e))

## [0.3.1](https://github.com/feathershq/pinion/compare/v0.3.0...v0.3.1) (2022-05-20)

### Bug Fixes

- Allow prompt to specify a different return type ([#17](https://github.com/feathershq/pinion/issues/17)) ([5d893da](https://github.com/feathershq/pinion/commit/5d893da11d72c8a3454029384c8a17ca2c10237d))
- Fix inject after handling and add error messages when lines were not found ([#19](https://github.com/feathershq/pinion/issues/19)) ([ceb9696](https://github.com/feathershq/pinion/commit/ceb9696c4330d5b132407a3930f32bad6b9dcd26))

### Features

- Add tracing mechanism ([#18](https://github.com/feathershq/pinion/issues/18)) ([4e20211](https://github.com/feathershq/pinion/commit/4e202117218b56e564321f2fa40fb80d19dfd597))

# [0.3.0](https://github.com/feathershq/pinion/compare/v0.2.7...v0.3.0) (2022-05-19)

### Features

- Do not merge context and remove runGenerator ([#16](https://github.com/feathershq/pinion/issues/16)) ([60c7e9e](https://github.com/feathershq/pinion/commit/60c7e9efacc51ecd4290bf9404fe40ee3f9660f3))

## [0.2.7](https://github.com/feathershq/pinion/compare/v0.2.6...v0.2.7) (2022-05-06)

### Bug Fixes

- Only run generators in the current folder, not recursively ([#15](https://github.com/feathershq/pinion/issues/15)) ([6e74853](https://github.com/feathershq/pinion/commit/6e7485345e9d95d942081d0b739c1b9afc008f9a))

## [0.2.6](https://github.com/feathershq/pinion/compare/v0.2.5...v0.2.6) (2022-05-03)

### Bug Fixes

- Escape inject pattern strings to not be treated as regular expressions ([#14](https://github.com/feathershq/pinion/issues/14)) ([ebfbdd7](https://github.com/feathershq/pinion/commit/ebfbdd75243dc3fa1bcc935d0420f5d935d14b6a))

## [0.2.5](https://github.com/feathershq/pinion/compare/v0.2.4...v0.2.5) (2022-05-02)

### Bug Fixes

- Fix runGenerator return type ([#12](https://github.com/feathershq/pinion/issues/12)) ([3f7bd1a](https://github.com/feathershq/pinion/commit/3f7bd1a1552f6762d6892dd054bd163f2c2cb5ed))

### Features

- Add when helper for conditional operations ([#13](https://github.com/feathershq/pinion/issues/13)) ([f75409d](https://github.com/feathershq/pinion/commit/f75409de4f5c0d8c754eda85732182ff0fa3a67f))

## [0.2.4](https://github.com/feathershq/pinion/compare/v0.2.3...v0.2.4) (2022-04-16)

### Bug Fixes

- Improve generator execution flow ([f47ec38](https://github.com/feathershq/pinion/commit/f47ec38aab281c1db46fe31738dd8a9697dd3191))

### Features

- Add copyFiles and mergeJSON operations ([#11](https://github.com/feathershq/pinion/issues/11)) ([4f8c2e2](https://github.com/feathershq/pinion/commit/4f8c2e27515c20b7cd64934dc91a7165e4075f1b))

## [0.2.3](https://github.com/feathershq/pinion/compare/v0.2.2...v0.2.3) (2022-03-25)

**Note:** Version bump only for package @featherscloud/pinion

## [0.2.2](https://github.com/feathershq/pinion/compare/v0.2.1...v0.2.2) (2022-03-11)

### Features

- Add simple package manager installation script ([#9](https://github.com/feathershq/pinion/issues/9)) ([5bbb767](https://github.com/feathershq/pinion/commit/5bbb76768f4a5f8f97bc2e088ed061f44ca2a75d))

## [0.2.1](https://github.com/feathershq/pinion/compare/v0.2.0...v0.2.1) (2022-03-10)

### Features

- Add loadJSON and writeJSON operations ([#7](https://github.com/feathershq/pinion/issues/7)) ([157c2ed](https://github.com/feathershq/pinion/commit/157c2ede34e511631855d4a81600e5f33eec4ff7))
- Allow to load compiled modules first and improve operations ([#8](https://github.com/feathershq/pinion/issues/8)) ([b7a347f](https://github.com/feathershq/pinion/commit/b7a347fac32fe7d678a2ddb59aedaf03e95f3d9e))

# [0.2.0](https://github.com/feathershq/pinion/compare/v0.1.0...v0.2.0) (2022-03-07)

### Bug Fixes

- Update references and trigger re-publish ([fb9060c](https://github.com/feathershq/pinion/commit/fb9060c359a7a3bd9ffd62c85fc6474f85dde6d3))

### Features

- Add inject operation ([#6](https://github.com/feathershq/pinion/issues/6)) ([b22af84](https://github.com/feathershq/pinion/commit/b22af84245bce5c57b8252ff77d36e618275e986))
- Improve CLI and add converter functionality ([#5](https://github.com/feathershq/pinion/issues/5)) ([6733c98](https://github.com/feathershq/pinion/commit/6733c987aff4f5d24183cf0473fe2ba6fc123f6d))

## [0.1.1](https://github.com/feathershq/pinion/compare/v0.1.0...v0.1.1) (2022-03-02)

### Bug Fixes

- Update references and trigger re-publish ([fb9060c](https://github.com/feathershq/pinion/commit/fb9060c359a7a3bd9ffd62c85fc6474f85dde6d3))

# 0.1.0 (2022-03-01)

### Features

- Initial Pinion prototype ([#3](https://github.com/feathershq/pinion/issues/3)) ([b08aacf](https://github.com/feathershq/pinion/commit/b08aacf22a5a61587243683a7d83097dbb576801))



================================================
FILE: packages/pinion/LICENSE
================================================
The MIT License (MIT)

Copyright (c) 2022 Feathers Cloud Inc.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.



================================================
FILE: packages/pinion/package.json
================================================
{
  "name": "@featherscloud/pinion",
  "description": "A fast and typesafe code generator",
  "version": "0.5.5",
  "homepage": "https://feathersjs.com",
  "main": "lib/index.js",
  "type": "module",
  "keywords": [
    "pinion",
    "generator",
    "typescript"
  ],
  "bin": {
    "pinion": "./bin/pinion.js"
  },
  "license": "MIT",
  "funding": {
    "type": "github",
    "url": "https://github.com/sponsors/daffl"
  },
  "repository": {
    "type": "git",
    "url": "git://github.com/feathershq/pinion.git"
  },
  "author": {
    "name": "Feathers contributors",
    "email": "hello@feathersjs.com",
    "url": "https://feathersjs.com"
  },
  "contributors": [],
  "bugs": {
    "url": "https://github.com/feathershq/pinion/issues"
  },
  "engines": {
    "node": ">= 20"
  },
  "files": [
    "CHANGELOG.md",
    "LICENSE",
    "README.md",
    "src/**",
    "lib/**",
    "*.d.ts",
    "*.js"
  ],
  "scripts": {
    "prepublish": "npm run compile",
    "compile": "shx rm -rf lib/ && tsc"
  },
  "directories": {
    "lib": "lib"
  },
  "publishConfig": {
    "access": "public"
  },
  "dependencies": {
    "@types/inquirer": "^9.0.7",
    "chalk": "^5.4.1",
    "commander": "^13.0.0",
    "inquirer": "^9.3.2",
    "tsx": "^4.19.2"
  },
  "devDependencies": {
    "@types/node": "^22.10.2",
    "shx": "^0.3.4",
    "typescript": "^5.7.2"
  },
  "gitHead": "a7580c163eaf4a0c38e7e0784d5e8785cdea6416"
}


================================================
FILE: packages/pinion/tsconfig.json
================================================
{
  "extends": "../../tsconfig",
  "include": [
    "src/**/*.ts"
  ],
  "compilerOptions": {
    "outDir": "lib"
  }
}



================================================
FILE: packages/pinion/src/cli.ts
================================================
import { dirname, join } from 'path'
import { existsSync, readFileSync } from 'fs'

import { Command } from 'commander'
import { fileURLToPath } from 'url'
import { getContext } from './core.js'
import { loadModule } from './utils.js'
import { isAbsolute } from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

const { version } = JSON.parse(readFileSync(join(__dirname, '../package.json'), 'utf8'))
const BASE_ACTIONS = ['help', '--help', '-h', '--version', '-V']

export const cli = async (cmd: string[]) => {
  const [generatorFile, ...argv] = cmd
  const program = new Command()

  program.name('pinion').description('The Pinion CLI')
  program.command('<file> [args...]').description('Run a generator file with command line arguments.')
  program.version(version)

  if (BASE_ACTIONS.includes(generatorFile)) {
    return program.parse(cmd, {
      from: 'user'
    })
  }

  if (!generatorFile) {
    throw new Error('Please specify a generator file name')
  }

  const moduleName = isAbsolute(generatorFile) ? generatorFile : join(process.cwd(), generatorFile)

  if (!existsSync(moduleName)) {
    throw new Error(`The generator file ${moduleName} does not exists`)
  }

  const module = await loadModule(moduleName)
  const generate = module.default?.generate || module.generate
  const generatorContext = getContext({ argv }, {})

  if (typeof generate !== 'function') {
    throw new Error('The generator file must export a generate function')
  }

  return generate(generatorContext)
}



================================================
FILE: packages/pinion/src/core.ts
================================================
import { spawn, SpawnOptions } from 'child_process'
import inquirer from 'inquirer'
import chalk from 'chalk'

import { loadModule } from './utils.js'

const { prompt } = inquirer
const { yellow, red, blue } = chalk

export interface Logger {
  warn: (msg: string) => void
  error: (msg: string) => void
  log: (msg: string) => void
  notice: (msg: string) => void
}

export class BasicLogger implements Logger {
  logger: typeof console = console
  previousNotice: string = ''

  warn(msg: string) {
    this.logger.log(yellow(`    ${msg}`))
  }

  error(msg: string) {
    this.logger.log(red(msg))
  }

  log(msg: string) {
    this.logger.log(msg)
  }

  notice(msg: string) {
    if (this.previousNotice !== msg) {
      this.logger.log(blue(`    ${msg}`))
      this.previousNotice = msg
    }
  }
}

export type PinionTrace = {
  name: string
  timestamp: number
  info: unknown
}

export type Configuration = {
  /**
   * The current working directory
   */
  cwd: string
  /**
   * The logger instance, writing information to the console
   */
  logger: Logger
  /*
   * Whether to force overwriting existing files by default
   */
  force: boolean
  /**
   * The prompt instance, used to ask questions to the user
   */
  prompt: typeof prompt
  /**
   * Trace messages of all executed generators
   */
  trace: PinionTrace[]
  /**
   * A function to execute a command
   *
   * @param command The command to execute
   * @param args The command arguments
   * @param options The NodeJS spawn options
   * @returns The exit code of the command
   */
  exec: (command: string, args: string[], options?: SpawnOptions) => Promise<number>
}

export type PinionContext = {
  /**
   * The current working directory
   */
  cwd: string
  /**
   * The command line arguments
   */
  argv: string[]
  pinion: Configuration
}

export type ContextCallable<T, C extends PinionContext> = (ctx: C) => T | Promise<T>
export type Callable<T, C extends PinionContext> = T | ContextCallable<T, C>
export type Promisable<T> = T | Promise<T>

/**
 * Returns the value for a callable which can either be a plain value or a
 * callback function that takes the context and returns the value.
 *
 * @param callable A plain value or a callback function that returns the value
 * @param context The current context object
 * @returns The final value
 */
export const getCallable = async <T, C extends PinionContext>(callable: Callable<T, C>, context: C) =>
  typeof callable === 'function' ? (callable as ContextCallable<T, C>)(context) : callable

export const mapCallables = <X, C extends PinionContext>(callables: Callable<X, C>[], context: C) =>
  Promise.all(callables.map((callable) => getCallable(callable, context)))

/**
 * Returns a new Pinion configuration object.
 *
 * @param initialConfig Any customized Pinion configuration settings
 * @returns
 */
export const getConfig = (initialConfig?: Partial<Configuration>): Configuration => ({
  prompt,
  logger: new BasicLogger(),
  cwd: process.cwd(),
  force: false,
  trace: [],
  exec: (command: string, args: string[], options?: SpawnOptions) => {
    const child = spawn(command, args, {
      stdio: 'inherit',
      shell: true,
      ...options
    })

    return new Promise((resolve, reject) => {
      child.once('exit', (code) => (code === 0 ? resolve(code) : reject(code)))
    })
  },
  ...initialConfig
})

/**
 * Returns a new Pinion context that can be passed to a generator.
 *
 * @param initialCtx The initial context data
 * @param initialConfig The initial Pinion configuration
 * @returns The initialized Pinion context.
 */
export const getContext = <T extends PinionContext>(
  initialCtx: Partial<T>,
  initialConfig: Partial<Configuration> = {}
) => {
  const pinion = getConfig(initialConfig)

  return {
    cwd: pinion.cwd,
    argv: [] as string[],
    ...initialCtx,
    pinion
  } as T
}

/**
 * Returns a Promise of the initial context
 * @param initialContext
 * @returns
 * @deprecated Use `Promise.resolve(context)` instead
 */
export const generator = async <T extends PinionContext>(initialContext: T) => initialContext

export const runModule = async (file: string, ctx: PinionContext) => {
  const { generate } = await loadModule(file)

  return generate(ctx)
}



================================================
FILE: packages/pinion/src/index.ts
================================================
export { loadModule } from './utils.js'
export * from './core.js'
export * from './tasks/index.js'
export * from './cli.js'



================================================
FILE: packages/pinion/src/utils.ts
================================================
import { existsSync } from 'fs'
import path from 'path'
import { pathToFileURL } from 'url'
import { readdir } from 'fs/promises'

let tsModule: any

const tsRegister = async (mod = 'tsx') => (tsModule = tsModule || import(mod))

const extensionCheck = /(\.ts|\.js)$/
const getFileUrl = (file: string) => {
  let url = file

  if (!extensionCheck.test(file)) {
    if (existsSync(`${file}.js`)) {
      url = `${file}.js`
    } else if (existsSync(`${file}.ts`)) {
      url = `${file}.ts`
    }
  }

  if (!url.startsWith('file://')) {
    url = pathToFileURL(url).href
  }

  return url
}

export const loadModule = async (file: string) => {
  const fileName = getFileUrl(file)

  if (fileName.endsWith('.ts')) {
    await tsRegister()
  }

  return import(fileName)
}

export const listFiles = async (folder: string, extension?: string): Promise<string[]> => {
  const list = await readdir(folder, { withFileTypes: true })
  const fileNames = list.filter((file) => file.isFile()).map(({ name }) => path.resolve(folder, name))

  return extension ? fileNames.filter((name) => name.endsWith(extension)) : fileNames
}

export const listAllFiles = async (folder: string): Promise<string[]> => {
  const list = await readdir(folder, { withFileTypes: true })
  const nameList = await Promise.all(
    list.map((file) => {
      const fullName = path.resolve(folder, file.name)

      return file.isDirectory() ? listAllFiles(fullName) : fullName
    })
  )

  return nameList.flat().sort()
}

export const merge = (target: { [key: string]: any }, source: { [key: string]: any }) => {
  for (const key of Object.keys(source)) {
    const value = source[key]

    if (value && typeof value === 'object' && !Array.isArray(value)) {
      target[key] = merge(target[key] || {}, value)
    } else {
      target[key] = value
    }
  }

  return target
}

export const formatString = (template: string, ...args: any[]) => template.replace(/%s/g, () => args.shift())



================================================
FILE: packages/pinion/src/tasks/commander.ts
================================================
import { Callable, PinionContext, getCallable } from '../core.js'
import type { Command } from 'commander'
import { addTrace } from './helpers.js'

/**
 * Parse the command line arguments using a commander instance and
 * add the parsed options to the context.
 * @param program The commander program instance
 * @returns
 */
export const commander =
  <C extends PinionContext>(program: Callable<Command, C>) =>
  async (ctx: C) => {
    const commander = await getCallable(program, ctx)

    const args = commander.parse(ctx.argv || [], {
      from: 'user'
    })
    const options = args.opts()

    return addTrace(
      {
        ...ctx,
        ...args.opts()
      },
      'commander',
      options
    )
  }



================================================
FILE: packages/pinion/src/tasks/conditionals.ts
================================================
import { PinionContext, Callable, getCallable } from '../core.js'
import { addTrace } from './helpers.js'

/**
 * Conditionally run an operation
 *
 * @param condition The condition to evaluate
 * @param operation The operation to run when the condition is true
 * @returns The updated context
 */
export const when =
  <C extends PinionContext>(condition: Callable<boolean, C>, ...operations: ((ctx: C) => Promise<C>)[]) =>
  async (ctx: C) => {
    const value = await getCallable(condition, ctx)
    const result = value
      ? await operations.reduce((current, op) => current.then(op as any), Promise.resolve(ctx))
      : ctx

    return addTrace(result, 'when', { value })
  }



================================================
FILE: packages/pinion/src/tasks/exec.ts
================================================
import { Callable, getCallable, PinionContext } from '../core.js'
import { addTrace } from './helpers.js'

/**
 * Run a command with arguments.
 *
 * @param cmd  The command to run
 * @param _args The arguments for the command
 * @returns The current context
 */
export const exec =
  <C extends PinionContext>(cmd: Callable<string, C>, _args: Callable<string[], C> = []) =>
  async (ctx: C) => {
    const command = await getCallable(cmd, ctx)
    const args = await getCallable(_args, ctx)

    ctx.pinion.logger.notice(`Running ${command} ${args.join(' ')}`)

    const exitCode = await ctx.pinion.exec(command, args, {
      cwd: ctx.cwd
    })

    if (exitCode !== 0) {
      throw new Error(`Command "${command}" exited with error code ${exitCode}`)
    }

    return addTrace(ctx, 'exec', { command, args })
  }



================================================
FILE: packages/pinion/src/tasks/fs.ts
================================================
import { resolve, dirname, relative, join } from 'path'
import { mkdir, readFile, writeFile, copyFile } from 'fs/promises'
import { PinionContext, Callable, mapCallables, getCallable } from '../core.js'
import { WriteFileOptions, promptWriteFile, overwrite, addTrace } from './helpers.js'
import { listAllFiles, merge } from '../utils.js'

export type FileNameOptions = {
  createFolders: boolean
  prompt: string
}

const fileName =
  (options: FileNameOptions) =>
  <C extends PinionContext>(...targets: Callable<string | string[], C>[]) => {
    const fn = async (ctx: C) => {
      const segments = (await mapCallables(targets, ctx)).flat()
      const fullPath = resolve(ctx.cwd, ...segments)

      if (options.createFolders) {
        await mkdir(dirname(fullPath), {
          recursive: true
        })
      }

      return fullPath
    }

    fn.file = options

    return fn
  }

export type FileCallable = ReturnType<ReturnType<typeof fileName>>

export const file = fileName({ createFolders: false, prompt: 'file' })
export const toFile = fileName({ createFolders: true, prompt: 'to file' })
export const fromFile = fileName({ createFolders: false, prompt: 'from file' })

export type JSONData = { [key: string]: any }

/**
 * Recursively copy all files from a folder to a destination.
 * Will prompt if the to file already exists.
 *
 * @param from The (local) folder to copy files from
 * @param to The destination to copy the files to
 * @param options File copy options (e.g. `{ force: true }`)
 * @returns The current context
 */
export const copyFiles =
  <C extends PinionContext>(
    from: Callable<string, C>,
    to: Callable<string, C>,
    options: Partial<WriteFileOptions> = {}
  ) =>
  async (ctx: C) => {
    const source = await getCallable(from, ctx)
    const target = await getCallable(to, ctx)
    const fileList = await listAllFiles(source)

    await Promise.all(
      fileList.map(async (file) => {
        const destination = join(target, relative(source, file))

        await mkdir(dirname(destination), {
          recursive: true
        })

        if (await overwrite(ctx, destination, options)) {
          await copyFile(file, destination)
        }
      })
    )

    return addTrace(ctx, 'copyFiles', { fileList, target, source })
  }

/**
 * Load a JSON file and merge the data into the context
 *
 * @param file The name of the JSON file
 * @param converter A converter that returns the data that will be merged into the context
 * @returns The current context
 */
export const loadJSON =
  <C extends PinionContext, X>(
    file: Callable<string, C>,
    converter: (data: JSONData, ctx: C) => X = (data) => data as X,
    fallback?: Callable<JSONData, C>
  ) =>
  async (ctx: C) => {
    const fileName = await getCallable(file, ctx)
    let data

    try {
      const content = (await readFile(fileName)).toString()
      data = JSON.parse(content)
    } catch (error) {
      if (fallback) {
        data = await getCallable(fallback, ctx)
      } else {
        throw error
      }
    }

    const converted = await converter(data, ctx)
    const result = {
      ...ctx,
      ...converted
    } as C & X

    return addTrace(result, 'loadJSON', { fileName, data })
  }

/**
 * Write formatted JSON to a file
 *
 * @param json The JSON data to write
 * @param file The filename to write to
 * @returns The current context
 */
export const writeJSON =
  <C extends PinionContext>(
    json: Callable<JSONData, C>,
    file: Callable<string, C>,
    options: Partial<WriteFileOptions> = {}
  ) =>
  async (ctx: C) => {
    const fileName = await getCallable(file, ctx)
    const data = await getCallable(json, ctx)
    const content = JSON.stringify(data, null, '  ')
    const result = await promptWriteFile(fileName, content, ctx, options)

    return addTrace(result, 'writeJSON', { fileName, data })
  }

/**
 * Merge an existing JSON file with new data
 *
 * @param json The JSON data to add to the file
 * @param file The filename to write to
 * @returns The current context
 */
export const mergeJSON =
  <C extends PinionContext>(json: Callable<JSONData, C>, file: Callable<string, C>) =>
  async (ctx: C) => {
    const fileName = await getCallable(file, ctx)
    const payload = await getCallable(json, ctx)
    const existingContent = (await readFile(fileName)).toString()
    const data = merge(JSON.parse(existingContent), payload)
    const content = JSON.stringify(data, null, '  ')

    await writeFile(fileName, content)

    return addTrace(ctx, 'mergeJSON', { fileName, payload })
  }



================================================
FILE: packages/pinion/src/tasks/helpers.ts
================================================
import { relative } from 'path'
import { existsSync } from 'fs'
import { writeFile } from 'fs/promises'
import { PinionContext } from '../core.js'

/**
 * Add tracing information on what happened to the Pinion context
 *
 * @param ctx The current context
 * @param name The name of the operation
 * @param data The data to log
 * @returns The current context
 */
export const addTrace = <C extends PinionContext>(ctx: C, name: string, info: unknown) => {
  ctx.pinion.trace = [...ctx.pinion.trace, { name, info, timestamp: Date.now() }]

  return ctx
}

export type WriteFileOptions = {
  force: boolean
}

export const overwrite = async <C extends PinionContext>(
  ctx: C,
  fileName: string,
  options: Partial<WriteFileOptions> = {}
) => {
  const { prompt, logger } = ctx.pinion
  const force = options.force !== undefined ? options.force : ctx.pinion.force
  const relativeName = relative(ctx.cwd, fileName)

  if (existsSync(fileName) && !force) {
    const { overwrite } = await prompt([
      {
        type: 'confirm',
        name: 'overwrite',
        message: `File ${relativeName} already exists. Overwrite?`
      }
    ])

    if (!overwrite) {
      logger.warn(`Skipped file ${relativeName}`)
      return false
    }
  }

  return true
}

export const promptWriteFile = async <C extends PinionContext>(
  fileName: string,
  content: string | Buffer,
  ctx: C,
  options: Partial<WriteFileOptions> = {}
) => {
  const { logger } = ctx.pinion
  const relativeName = relative(ctx.cwd, fileName)

  if (await overwrite(ctx, fileName, options)) {
    await writeFile(fileName, content)
    logger.notice(`Wrote file ${relativeName}`)
  }

  return ctx
}



================================================
FILE: packages/pinion/src/tasks/index.ts
================================================
export * from './prompt.js'
export * from './render.js'
export * from './inject.js'
export * from './run.js'
export * from './fs.js'
export * from './exec.js'
export * from './conditionals.js'
export * from './commander.js'
export { Command } from 'commander'



================================================
FILE: packages/pinion/src/tasks/inject.ts
================================================
import { existsSync } from 'fs'
import { relative } from 'path'
import { readFile, writeFile } from 'fs/promises'
import { EOL } from 'os'
import { PinionContext, Callable, getCallable } from '../core.js'
import { addTrace } from './helpers.js'

const EOLRegex = /\r?\n/

const newline = (str: string) => {
  const newlines = str.match(/(?:\r?\n)/g) || []

  if (newlines.length === 0) {
    return EOL
  }

  const crlf = newlines.filter((newline) => newline === '\r\n').length
  const lf = newlines.length - crlf

  return crlf > lf ? '\r\n' : '\n'
}

export type Location<C extends PinionContext> = (
  lines: string[],
  ctx: C,
  fileName: string
) => Promise<{ index: number; pattern?: string | RegExp | undefined }>

/**
 * Inject a template into a file at a specific location. All locations are line based.
 *
 * @param template The content to inject
 * @param location The location where to inject. Can be one of `before()`, `after()`, `prepend()` or `append()`
 * @param target The target file to inject to
 * @returns The current context
 */
export const inject =
  <C extends PinionContext>(
    template: Callable<string, C>,
    location: Location<C>,
    target: Callable<string, C>
  ) =>
  async (ctx: C) => {
    const fileName = await getCallable(target, ctx)
    const content = await getCallable(template, ctx)
    const relativeName = relative(ctx.cwd, fileName)

    if (!existsSync(fileName)) {
      throw new Error(`Cannot inject to '${fileName}'. The file doesn't exist.`)
    }

    const fileContent = (await readFile(fileName)).toString()

    const NL = newline(fileContent)
    const lines = fileContent.split(NL)

    const { index } = await location(lines, ctx, relativeName)

    if (index >= 0) {
      lines.splice(index, 0, content)
    }

    const newContent = lines.join(NL)

    await writeFile(fileName, newContent)

    ctx.pinion.logger.notice(`Updated ${relativeName}`)

    return addTrace(ctx, 'inject', { fileName, content })
  }

const escapeString = (str: string) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')

const getLineNumber = (pattern: string | RegExp, lines: string[], isBefore: boolean) => {
  const matcher = pattern instanceof RegExp ? pattern : new RegExp(escapeString(pattern), 'm')
  const oneLineMatchIndex = lines.findIndex((l) => l.match(matcher))

  if (oneLineMatchIndex < 0) {
    const fullText = lines.join('\n')
    const fullMatch = fullText.match(matcher)

    if (fullMatch && fullMatch.length) {
      if (isBefore) {
        const fullTextUntilMatchStart = fullText.substring(0, fullMatch.index)
        return fullTextUntilMatchStart.split(EOLRegex).length - 1
      }
      const matchEndIndex = (fullMatch.index || 0) + fullMatch.toString().length
      const fullTextUntilMatchEnd = fullText.substring(0, matchEndIndex)
      return fullTextUntilMatchEnd.split(EOLRegex).length
    }

    return oneLineMatchIndex
  }

  return oneLineMatchIndex + (isBefore ? 0 : 1)
}

/**
 * Inject before a line matching the given pattern.
 *
 * @param pattern The pattern to inject before
 * @returns The location used by the `inject` task
 */
export const before =
  <C extends PinionContext>(pattern: Callable<string | RegExp, C>) =>
  async (lines: string[], ctx: C, fileName: string) => {
    const line = await getCallable(pattern, ctx)
    const index = getLineNumber(line, lines, true)

    if (index < 0) {
      throw new Error(`Could not find line '${line}' in file ${fileName} to inject content before`)
    }

    return { index, pattern: line }
  }

/**
 * Inject after a line matching a given pattern.
 *
 * @param pattern The pattern to inject after
 * @returns The location used by the `inject` task
 */
export const after =
  <C extends PinionContext>(pattern: Callable<string | RegExp, C>) =>
  async (lines: string[], ctx: C, fileName: string) => {
    const line = await getCallable(pattern, ctx)
    const index = getLineNumber(line, lines, false)

    if (index < 0) {
      throw new Error(`Could not find line '${line}' in file ${fileName} to inject content after`)
    }

    return { index, pattern: line }
  }

/**
 * Inject at the beginning of a file.
 *
 * @returns The location used by the `inject` task
 */
export const prepend = () => async () => {
  return { index: 0 }
}

/**
 * Append at the end of a file.
 *
 * @returns The location used by the `inject` task.
 */
export const append = () => async (lines: string[]) => {
  return { index: lines.length }
}



================================================
FILE: packages/pinion/src/tasks/prompt.ts
================================================
import { Question, QuestionCollection } from 'inquirer'
import { PinionContext, Callable, getCallable } from '../core.js'
import { addTrace } from './helpers.js'

/**
 * Get the type from an Inquirer question
 */
export type AnswerType<Q extends Question> = Q extends { type: 'input' }
  ? string
  : Q extends { type: 'list' }
    ? string
    : Q extends { type: 'rawlist' }
      ? string
      : Q extends { type: 'number' }
        ? number
        : Q extends { type: 'password' }
          ? string
          : Q extends { type: 'confirm' }
            ? boolean
            : Q extends { type: 'checkbox' }
              ? string[]
              : Q extends { type: 'editor' }
                ? string
                : unknown

/**
 * Get the types for the answers from a prompt() function
 */
export type AnswerTypes<Q extends QuestionCollection> =
  Q extends ReadonlyArray<Question & { name: string }>
    ? { [K in Q[number] as K['name']]: AnswerType<K> }
    : Q extends { [key: string]: Question }
      ? {
          [K in keyof Q]: AnswerType<Q[K]>
        }
      : unknown

/**
 * Show prompts using Inquirer
 *
 * @param prompts The prompt questions to ask
 * @returns The generator context updated with the prompt results
 */
export const prompt =
  <C extends PinionContext, Q extends QuestionCollection = QuestionCollection>(prompts: Callable<Q, C>) =>
  async (ctx: C) => {
    const answers = await ctx.pinion.prompt(await getCallable(prompts, ctx))
    const result = {
      ...ctx,
      ...answers
    } as C & AnswerTypes<Q>

    return addTrace(result, 'prompt', answers)
  }

/**
 * Get the types for the answers from a prompt() function
 */
export type Answers<T extends ReturnType<typeof prompt>> = ReturnType<T> extends Promise<infer U> ? U : never



================================================
FILE: packages/pinion/src/tasks/render.ts
================================================
import { PinionContext, Callable, getCallable } from '../core.js'
import { WriteFileOptions, promptWriteFile, addTrace } from './helpers.js'

/**
 * Renders a template to a file.
 *
 * @param template The template to render
 * @param target The target file handle, usually provided by `to()`
 * @returns The generator context
 */
export const renderTemplate =
  <C extends PinionContext>(
    template: Callable<string, C>,
    target: Callable<string, C>,
    options: Partial<WriteFileOptions> = {}
  ) =>
  async (ctx: C) => {
    const fileName = await getCallable(target, ctx)
    const content = await getCallable(template, ctx)
    const result = await promptWriteFile(fileName, content, ctx, options)

    return addTrace(result, 'renderTemplate', { fileName, content })
  }



================================================
FILE: packages/pinion/src/tasks/run.ts
================================================
import { join } from 'path'
import { stat } from 'fs/promises'
import { PinionContext, Callable, runModule, mapCallables } from '../core.js'
import { listFiles } from '../utils.js'
import { addTrace } from './helpers.js'

const getFileName = async <C extends PinionContext>(ctx: C, pathParts: Callable<string | string[], C>[]) => {
  const segments = (await mapCallables(pathParts, ctx)).flat()

  return join(...segments)
}

/**
 * Run all Pinion generators within a folder in sequence, ordered by name
 *
 * @param pathParts The parts of the folder to run. Can be assembled dynamically based on context.
 * @returns The context returned by all generators merged together
 */
export const runGenerators =
  <C extends PinionContext>(...pathParts: Callable<string, C>[]) =>
  async (ctx: C) => {
    const name = await getFileName(ctx, pathParts)
    const handle = await stat(name)

    if (!handle.isDirectory()) {
      throw new Error(`${name} must be a directory (runGenerators)`)
    }

    const [compiledFiles, tsFiles] = await Promise.all([
      listFiles(name, '.tpl.js'),
      listFiles(name, '.tpl.ts')
    ])
    const files = compiledFiles.length ? compiledFiles : tsFiles

    for (const file of files.sort()) {
      await runModule(file, ctx)
    }

    return addTrace(ctx, 'runGenerators', { files })
  }

/**
 * Run a single generator file
 *
 * @param pathParts The parts of the folder to run. Can be assembled dynamically based on context.
 * @returns The current and generator context merged together
 */
export const runGenerator =
  <C extends PinionContext>(...pathParts: Callable<string, C>[]) =>
  async (ctx: C) => {
    const name = await getFileName(ctx, pathParts)

    await runModule(name, ctx)

    return ctx
  }



================================================
FILE: packages/pinion/test/cli.test.ts
================================================
import { describe, it } from 'vitest'
import assert from 'assert'
import { fileURLToPath } from 'url'
import { dirname } from 'path'
import { cli } from '../src/index.js'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

describe('@featherscloud/pinion/cli', () => {
  it('runs the CLI with a generator and command line arguments', async () => {
    const ctx = await cli(['packages/pinion/test/templates/cli.ts', '--name', 'testing'])

    assert.ok(ctx.noop)
    assert.strictEqual(ctx.name, 'testing')
  })

  it('errors without generator file', async () => {
    try {
      await cli([])
    } catch (error) {
      assert.strictEqual(error.message, 'Please specify a generator file name')
    }
  })
})



================================================
FILE: packages/pinion/test/index.test.ts
================================================
import { describe, it } from 'vitest'
import path from 'path'
import { fileURLToPath } from 'url'
import { readFile } from 'fs/promises'
import assert from 'assert'
import { getContext, PinionContext, runModule } from '../src/index.js'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const expectedFileContent = `<!-- Prepended -->
This is injected before

# Hello (world)

This is injected after
<!-- Appended -->`

interface NamedContext extends PinionContext {
  name: string
  finalized: boolean
}

describe('@featherscloud/pinion', () => {
  const rootGenerator = path.join(__dirname, 'templates', 'pinion.ts')

  it('simple', async () => {
    const initialCtx = getContext<NamedContext>(
      {
        name: 'Simple test'
      },
      {
        force: true,
        cwd: __dirname
      }
    )
    const ctx: NamedContext = await runModule(rootGenerator, initialCtx)
    const json = JSON.parse((await readFile(path.join(__dirname, './tmp/testing.json'))).toString())

    assert.ok(ctx.finalized)
    assert.deepStrictEqual(json, {
      written: true,
      example: {
        message: 'This is an example JSON file'
      },
      merged: true
    })

    const { trace } = ctx.pinion

    assert.strictEqual(trace[0].name, 'renderTemplate')
    assert.strictEqual((trace[0].info as any).content, '# Hello (world)')

    const written = await readFile(path.join(__dirname, 'tmp', 'hello.md'))
    const writtenJSON = JSON.parse((await readFile(path.join(__dirname, 'tmp', 'testing.json'))).toString())

    assert.strictEqual(written.toString().replace(/\r/g, ''), expectedFileContent)

    assert.deepStrictEqual(writtenJSON, {
      written: true,
      merged: true,
      example: {
        message: 'This is an example JSON file'
      }
    })
  })
})



================================================
FILE: packages/pinion/test/utils.test.ts
================================================
import { describe, it } from 'vitest'
import path from 'path'
import assert from 'assert'
import { merge, listAllFiles, loadModule, listFiles } from '../src/utils.js'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

describe('@featherscloud/pinion/utils', () => {
  it('listFiles with extension', async () => {
    const files = await listFiles(path.join(__dirname, 'templates'), '.tpl.ts')

    assert.strictEqual(files.length, 1)
  })

  it('listAllFiles recursive', async () => {
    const files = await listAllFiles(path.join(__dirname))

    assert.ok(files.length > 4)
  })

  it('merge', () => {
    const merged = merge(
      {
        some: { thing: true }
      },
      {
        some: { other: 'message' },
        value: { deep: true }
      }
    )

    assert.deepStrictEqual(merged, {
      some: { thing: true, other: 'message' },
      value: { deep: true }
    })
  })

  describe('loadModule', () => {
    it('loads .js when available and no extension is given', async () => {
      const { doSomething } = await loadModule(path.join(__dirname, 'fixtures', 'convertable'))

      assert.strictEqual(doSomething('Feathers'), 'Yo Feathers')
    })

    it('loads .ts and compiles when full path is given', async () => {
      const { doSomething } = await loadModule(path.join(__dirname, 'fixtures', 'convertable.ts'))

      assert.strictEqual(doSomething('Feathers'), 'Hello Feathers')
    })
  })
})



================================================
FILE: packages/pinion/test/fixtures/convertable.js
================================================
export const doSomething = name => `Yo ${name}`



================================================
FILE: packages/pinion/test/fixtures/convertable.ts
================================================
export const doSomething = (name: string) => `Hello ${name}`



================================================
FILE: packages/pinion/test/fixtures/example.json
================================================
{
  "message": "This is an example JSON file"
}


================================================
FILE: packages/pinion/test/templates/cli.ts
================================================
import { PinionContext, commander, Command } from '../../src/index.js'

interface Context extends PinionContext {
  name: string
}

const program = new Command()
  .description('A test command')
  .option('-n, --name <name>', 'Name of your project')

export const generate = (ctx: Context) =>
  Promise.resolve(ctx)
    .then(commander(program))
    .then((ctx) => ({ ...ctx, noop: true }))



================================================
FILE: packages/pinion/test/templates/json.tpl.ts
================================================
import { fileURLToPath } from 'url'
import { dirname } from 'path'
const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
import { loadJSON, fromFile, toFile, writeJSON, mergeJSON, PinionContext } from '../../src/index.js'

export const generate = (ctx: PinionContext) =>
  Promise.resolve(ctx)
    .then(loadJSON(fromFile(__dirname, '..', 'fixtures', 'example.json'), (example) => ({ example })))
    .then(
      writeJSON(
        (ctx) => {
          return {
            written: true,
            example: ctx.example
          }
        },
        toFile('tmp', () => ['testing.json'])
      )
    )
    .then(mergeJSON({ merged: true }, toFile('tmp', 'testing.json')))



================================================
FILE: packages/pinion/test/templates/noop.ts
================================================
import { PinionContext } from '../../src/index.js'

export const generate = (ctx: PinionContext) => Promise.resolve(ctx)



================================================
FILE: packages/pinion/test/templates/pinion.ts
================================================
import { fileURLToPath } from 'url'
import { dirname } from 'path'
import {
  PinionContext,
  runGenerators,
  renderTemplate,
  when,
  prompt,
  inject,
  toFile,
  fromFile,
  after,
  prepend,
  append,
  before,
  exec,
  copyFiles
} from '../../src/index.js'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

export interface GeneratorContext extends PinionContext {
  name: string
  order: string[]
  a: boolean
  b: boolean
  finalized: boolean
}

export type GeneratorArguments = PinionContext & Partial<Pick<GeneratorContext, 'name'>>

export const generate = (ctx: GeneratorArguments) =>
  Promise.resolve(ctx)
    .then(renderTemplate('# Hello (world)', toFile('tmp', 'hello.md')))
    .then(inject('\nThis is injected after', after('Hello (world)'), toFile('tmp', 'hello.md')))
    .then(inject('This is injected before\n', before(/Hello\s/), toFile('tmp', 'hello.md')))
    .then(inject('<!-- Prepended -->', prepend(), toFile('tmp', 'hello.md')))
    .then(inject('<!-- Appended -->', append(), toFile('tmp', 'hello.md')))
    .then(
      prompt((ctx) => ({
        name: {
          type: 'input',
          when: !ctx.name
        },
        age: {
          type: 'number',
          when: !ctx.name
        }
      }))
    )
    .then(
      when(
        (ctx) => !!ctx.name && !ctx.age,
        exec('echo', () => ['"This is a test"'])
      )
    )
    .then(copyFiles(fromFile(__dirname), toFile('tmp', 'copy')))
    .then(runGenerators(__dirname))
    .then((ctx) => ({
      ...ctx,
      finalized: true
    }))



================================================
FILE: .github/contributing.md
================================================
# Contributing to Feathers

Thank you for contributing to Feathers! :heart: :tada:

Feathers embraces modularity and is broken up across multiple modules. You can find them all in the `packages/` folder. Most reflect their name on npm. For example, the code for `@feathersjs/feathers` will be in `packages/feathers`, for `@feathersjs/authentication` in `packages/authenticaiton`.

## Report a bug

Before creating an issue please make sure you have checked out the docs, specifically the [FAQ](https://docs.feathersjs.com/help/faq.html) section. You might want to also try searching Github. It's pretty likely someone has already asked a similar question.

If you haven't found your answer please feel free to join our [Discord server](https://discord.gg/qa8kez8QBx), create an issue on Github, or post on [Stackoverflow](http://stackoverflow.com) using the `feathersjs` tag. We try our best to monitor Stackoverflow but you're likely to get more immediate responses in Slack and Github.

Issues can be reported in the [issue tracker](https://github.com/feathersjs/feathers/issues). Since feathers combines many modules it can be hard for us to assess the root cause without knowing which modules are being used and what your configuration looks like, so **it helps us immensely if you can link to a simple example that reproduces your issue**.

## Report a Security Concern

We take security very seriously at Feathers. We welcome any peer review of our 100% open source code to ensure nobody's Feathers app is ever compromised or hacked. As a web application developer you are responsible for any security breaches. We do our very best to make sure Feathers is as secure as possible by default.

In order to give the community time to respond and upgrade we strongly urge you report all security issues to us. Send one of the core team members a PM in [Discord](https://discord.gg/qa8kez8QBx) or email us at <a href="mailto:">hello@feathersjs.com</a> with details and we will respond ASAP.

For full details refer to our [Security docs](https://docs.feathersjs.com/SECURITY.html).

## Pull Requests

We :heart: pull requests and we're continually working to make it as easy as possible for people to contribute.

We prefer small pull requests with minimal code changes. The smaller they are the easier they are to review and merge. A FeathersJS maintainer will pick up your PR and review it as soon as they can. They may ask for changes or reject your pull request. This is not a reflection of you as an engineer or a person. Please accept feedback graciously as we will also try to be sensitive when providing it.

Although we generally accept many PRs they can be rejected for many reasons. We will be as transparent as possible but it may simply be that you do not have the same context, historical knowledge or information regarding the roadmap that the maintainers have. We value the time you take to put together any contributions so we pledge to always be respectful of that time and will try to be as open as possible so that you don't waste it. :smile:

**All PRs (except documentation) should be accompanied with tests and pass the linting rules.**

### Code style

Before running the tests from the `test/` folder `npm test` will run ESlint. You can check your code changes individually by running `npm run lint`.

### Tests

[Mocha](http://mochajs.org/) tests are located in the `test/` folder and can be run using the `npm run mocha` or `npm test` (with ESLint and code coverage) command.

### Documentation

Feathers documentation is contained in Markdown files in the [docs](https://github.com/feathersjs/docs) repository. To change the documentation submit a pull request to that repo, referencing any other PR if applicable, and the docs will be updated with the next release.

## Community Contributions

If you've written something awesome about Feathers, for the Feathers ecosystem, or created an app using Feathers please add it to the [awesome-feathersjs](https://github.com/feathersjs-ecosystem/awesome-feathersjs).

If you are looking to create a new plugin you also might want to check out the [Plugin Generator](https://github.com/feathersjs/generator-feathers-plugin) that can be used to scaffold plugins to be Feathers compliant from the start.

If you think your module would be a good core `feathersjs` module or `featherjs-ecosystem` module then please contact one of the Feathers maintainers on [Discord](https://discord.gg/qa8kez8QBx) and we can discuss whether it belongs and how to get it there. :beers:

## Contributor Code of Conduct

As contributors and maintainers of this project, we pledge to respect all people who contribute through reporting issues, posting feature requests, updating documentation, submitting pull requests or patches, and other activities.

We are committed to making participation in this project a harassment-free experience for everyone, regardless of level of experience, gender, gender identity and expression, sexual orientation, disability, personal appearance, body size, race, ethnicity, age, or religion.

Examples of unacceptable behavior by participants include the use of sexual language or imagery, derogatory comments or personal attacks, trolling, public or private harassment, insults, or other unprofessional conduct.

Project maintainers have the right and responsibility to remove, edit, or reject comments, commits, code, wiki edits, issues, and other contributions that are not aligned to this Code of Conduct. Project maintainers who do not follow the Code of Conduct may be removed from the project team.

Instances of abusive, harassing, or otherwise unacceptable behavior may be reported by opening an issue or contacting one or more of the project maintainers.

This Code of Conduct is adapted from the [Contributor Covenant](http://contributor-covenant.org), version 1.0.0, available at [http://contributor-covenant.org/version/1/0/0/](http://contributor-covenant.org/version/1/0/0/)



================================================
FILE: .github/FUNDING.yml
================================================
# These are supported funding model platforms

github: [ daffl ]
patreon: # Replace with a single Patreon username
open_collective: #
ko_fi: # Replace with a single Ko-fi username
tidelift: # Replace with a single Tidelift platform-name/package-name e.g., npm/babel
community_bridge: # Replace with a single Community Bridge project-name e.g., cloud-foundry
custom: # Replace with a single custom sponsorship URL



================================================
FILE: .github/issue_template.md
================================================
### Steps to reproduce

(First please check that this issue is not already solved as [described
here](https://github.com/feathersjs/feathers/blob/crow/.github/contributing.md#report-a-bug))

- [ ] Tell us what broke. The more detailed the better.
- [ ] If you can, please create a simple example that reproduces the issue and link to a gist, jsbin, repo, etc. This makes it much easier for us to debug and issues that have a reproducable example will get higher priority.

### Expected behavior
Tell us what should happen

### Actual behavior
Tell us what happens instead

### System configuration

Tell us about the applicable parts of your setup.

**Module versions** (especially the part that's not working):

**NodeJS version**:

**Operating System**:

**Browser Version**:

**React Native Version**:

**Module Loader**:



================================================
FILE: .github/pull_request_template.md
================================================
### Summary

(If you have not already please refer to the contributing guideline as [described
here](https://github.com/feathersjs/feathers/blob/crow/.github/contributing.md#pull-requests))

- [ ] Tell us about the problem your pull request is solving.
- [ ] Are there any open issues that are related to this?
- [ ] Is this PR dependent on PRs in other repos?

If so, please mention them to keep the conversations linked together.

### Other Information

If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

Your PR will be reviewed by a core team member and they will work with you to get your changes merged in a timely manner. If merged your PR will automatically be added to the changelog in the next release.

If your changes involve documentation updates please mention that and link the appropriate PR in [feathers-docs](https://github.com/feathersjs/feathers-docs).

Thanks for contributing to Feathers! :heart:


================================================
FILE: .github/workflows/nodejs.yml
================================================
name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x, 21.x]

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci
      - run: npm test
        env:
          CI: true

  build-windows:
    runs-on: windows-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci
      - run: npm test
        env:
          CI: true



================================================
FILE: .github/workflows/update-dependencies.yml
================================================
name: Update dependencies

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:
jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '20.x'
      - run: npm ci
      - run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "hello@feathersjs.com"
          git checkout -b update-dependencies-$GITHUB_RUN_ID
      - run: |
          npm run update-dependencies
          npm install
      - run: |
          git commit -am "chore(dependencies): Update dependencies"
          git push origin update-dependencies-$GITHUB_RUN_ID
      - run: |
          gh pr create --title "chore(dependencies): Update all dependencies" --body ""
        env:
          GH_TOKEN: ${{ github.token }}
      - run: npm test


